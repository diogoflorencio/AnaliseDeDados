---
title: "R Notebook"
output: html_notebook
---

```{r}
require(GGally, quietly = TRUE)
require(reshape2, quietly = TRUE)
require(tidyverse, quietly = TRUE, warn.conflicts = FALSE)
library(ggfortify)
library(cluster)
library(ggdendro)
library(broom)
library(tidyverse)
library(plotly)
```
Os dados escolhidos para este laboratório são referentes as unidades acadêmicas da UFCG. Analisando os dados de modo geral, observei a existência de algumas unidades acadêmicas que possuem 1,2 ou 3 funcionários, valores estranhos. Deste modo, considerei apenas unidades acadêmicas que possuem mais de 10 funcionários.
```{r}
dados <- read.csv("../dados/ufcg-201704-sumario-UAs-wide.csv",encoding="UTF-8")
dados <- dados %>%
  group_by(unidade_academica = UORG_LOTACAO) %>% 
   summarise(total_funcionarios = sum(Outro,Professor.20h,Professor.40h.ou.DE),
              Professor.40h.ou.DE = Professor.40h.ou.DE, 
              idade_mediana = idade_mediana)%>%
  filter(total_funcionarios > 10) %>%
  ungroup()
```
As variáveis escolhidas para o agrupamento foram `total de funcionários`, `Professor.40h.ou.DE` e `idade mediana`; uma descrição mais detalhada sobre os dados está disponível [aqui](https://github.com/nazareno/ciencia-de-dados-1). As escalas originais das variáveis apresentam uma diferença significativa em seus valores, deste modo foram normalizadas prevenindo que uma variável domine a análise. 
```{r}
dados.scaled = dados %>% 
    mutate_each(funs(log), 2:4) %>% 
    mutate_each(funs(as.vector(scale(.))), 2:4)

dados.scaled %>% 
    select(-unidade_academica) %>% 
    ggpairs()
```
Pode-se definir o número de `clusters` do agrupamento, por meio do calculo da distância quadrática entre o centro dos clusters, o centro dos dados e os dados. Aqui o centro dos dados é um ponto imaginário na média de todas as variáveis. O gráfico relaciona as variáveis `betweenss` e `totss`. Essa proporção pode ser usada para definir um bom valor para o número de `clusters`. Quando ela para de crescer, para de valer à pena aumentar os `clusters`. Neste caso, um bom valor para o número de `clusters`seria 4.
```{r}
set.seed(123)
explorando_clusters = tibble(clusters = 1:15) %>% 
    group_by(clusters) %>% 
    do(
        kmeans(select(dados.scaled, -unidade_academica), 
               centers = .$clusters, 
               nstart = 20) %>% glance()
    )

explorando_clusters %>% 
    ggplot(aes(x = clusters, y = betweenss / totss)) + 
    geom_line(color = "blue") + 
    geom_point(color = "red")
```
## Agrupamento kmeans

Após definir 
```{r}
n_clusters = 4
set.seed(123)
km = dados.scaled %>% 
    select(-unidade_academica) %>% 
    kmeans(centers = n_clusters, nstart = 20)

# O df em formato longo, para visualização 
dados.long = km %>% 
    augment(dados.scaled) %>% # Adiciona o resultado de km 
                            # aos dados originais dw2.scaled em 
                            # uma variável chamada .cluster
    gather(key = "variável", 
           value = "valor", 
           -unidade_academica, -.cluster) # = move para long todas as 
                                            # variávies menos repository_language 
                                            # e .cluster

dados.long %>% 
    ggplot(aes(x = `variável`, y = valor, group = unidade_academica, colour = .cluster)) + 
    #geom_point(alpha = 0.2) + 
    geom_line(alpha = .5) + 
    facet_wrap(~ .cluster) 

autoplot(km, data = dados, label = TRUE)

```


```{r}
#summary(dw2.scaled)
km %>% 
    augment(dados) %>%
    plot_ly(type = 'parcoords',
            line = list(color = ~.cluster, 
                        showScale = TRUE),
            dimensions = list(
                #list(range = c(1, 4), label = "cluster", values = ~cluster),
                list(#range = c(-3, 3),
                     label = 'Total_funcionarios/UA', values = ~total_funcionarios),
                list(#range = c(-3, 3),
                     label = 'Professor.40h.ou.DE/UA', values = ~Professor.40h.ou.DE),
                list(#range = c(-2, 3),
                     label = 'idade_mediana/UA', values = ~idade_mediana)
            )
    )
```




