---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
require(GGally, quietly = TRUE)
require(reshape2, quietly = TRUE)
require(tidyverse, quietly = TRUE, warn.conflicts = FALSE)
library(ggfortify)
library(cluster)
library(ggdendro)
library(broom)
library(tidyverse)
```

```{r}
dados <- read.csv("../dados/ufcg-201704-sumario-UAs-wide.csv",encoding="UTF-8")
dados <- dados %>%
  group_by(unidade_academica = UORG_LOTACAO) %>% 
   summarise(total_funcionarios = sum(Outro,Professor.20h,Professor.40h.ou.DE),
              Professor.40h.ou.DE = Professor.40h.ou.DE, 
              idade_mediana = idade_mediana)%>%
  filter(total_funcionarios > 3) %>%
  ungroup()

```


```{r}
dados %>% 
    select(-unidade_academica) %>% 
    ggpairs()
```
##kmeans

```{r}
n_clusters = 4

km = dados %>% 
    select(-unidade_academica) %>% 
    kmeans(centers = n_clusters, nstart = 20)

# O df em formato longo, para visualização 
dados.long = km %>% 
    augment(dados) %>% # Adiciona o resultado de km 
                            # aos dados originais dw2.scaled em 
                            # uma variável chamada .cluster
    gather(key = "variável", 
           value = "valor", 
           -unidade_academica, -.cluster) # = move para long todas as 
                                            # variávies menos repository_language 
                                            # e .cluster

dados.long %>% 
    ggplot(aes(x = `variável`, y = valor, group = unidade_academica, colour = .cluster)) + 
    #geom_point(alpha = 0.2) + 
    geom_line(alpha = .5) + 
    facet_wrap(~ .cluster) 

autoplot(km, data = dados, label = TRUE)

dists = dados %>% 
    select(-unidade_academica) %>% 
    dist() # só para plotar silhouetas depois
plot(silhouette(km$cluster, dists), col = RColorBrewer::brewer.pal(n_clusters, "Set2"))

table(km %>% pull(cluster))

```


```{r}
#summary(dw2.scaled)
km %>% 
    augment(dados) %>%
    plot_ly(type = 'parcoords',
            line = list(color = ~.cluster, 
                        showScale = TRUE),
            dimensions = list(
                #list(range = c(1, 4), label = "cluster", values = ~cluster),
                list(range = c(-3, 3),
                     label = 'Total_funcionarios/UA', values = ~total_funcionarios),
                list(range = c(-3, 3),
                     label = 'Professor.40h.ou.DE/UA', values = ~Professor.40h.ou.DE),
                list(range = c(-2, 3),
                     label = 'idade_mediana/UA', values = ~idade_mediana)
            )
    )
```


```{r}
set.seed(123)
explorando_k = tibble(k = 1:15) %>% 
    group_by(k) %>% 
    do(
        kmeans(select(dados, -unidade_academica), 
               centers = .$k, 
               nstart = 20) %>% glance()
    )

explorando_k %>% 
    ggplot(aes(x = k, y = betweenss / totss)) + 
    geom_line() + 
    geom_point()
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
